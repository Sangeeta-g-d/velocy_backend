{% extends 'admin_base.html' %}
{% load static %}
{% block content %}
<style>
.city-search-container {
  position: relative;
}

.city-suggestions {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1000;
  display: none;
}

.city-suggestion {
  padding: 8px 12px;
  cursor: pointer;
}

.city-suggestion:hover {
  background-color: #f5f5f5;
}

.highlight {
  background-color: #e3f2fd;
  font-weight: bold;
}
</style>
<div class="container">
  <div class="top-controls">
    <a href="{% url 'fare_management' %}" class="btn btn-primary">Manage Fare</a>
    <div class="right-buttons">
      <button class="btn btn-primary open-modal-btn" data-modal="addCityModal">Add City</button>
      <button class="btn btn-secondary open-modal-btn" data-modal="addVehicleModal">Add Vehicle Type</button>
    </div>
  </div>
<div class="container">
    <!-- Your existing content like vehicle cards, forms, etc. -->

    <h3 style="margin-top: 40px;">City Vehicle Price List</h3>

    <table class="styled-table">
        <thead>
            <tr>
                <th>City</th>
                <th>Vehicle Type</th>
                <th>Price per Km (â‚¹)</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for item in city_vehicle_prices %}
            <tr>
                <td>{{ item.city.name }}</td>
                <td>{{ item.vehicle_type.name }}</td>
                <td>{{ item.price_per_km }}</td>
                <td><a href="javascript:void(0);" title="Delete" class="btn btn-danger" onclick="deleteVehiclePrice('{{ item.id }}')"><i class="fas fa-trash-alt"></i></a></td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="3">No fare data found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
  <div class="tables-wrapper">  
    <!-- Vehicle Table -->
    <div class="table-container">
      <h5 style="font-size: 17px;">Vehicle Types</h5>
      <table class="styled-table">
        <thead>
          <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Passengers</th>
            <th>Image</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for vehicle in vehicle_types %}
          <tr>
            <td>{{vehicle.id}}</td>
            <td>{{ vehicle.name }}</td>
            <td>{{ vehicle.number_of_passengers }}</td>
            <td>
              {% if vehicle.image %}
                <img src="{{ vehicle.image.url }}" width="50" height="50" style="object-fit: cover; border-radius: 4px;" />
              {% else %}
                N/A
              {% endif %}
            </td>
            <td>
             <a href="javascript:void(0);" onclick="openEditModal('{{ vehicle.id }}')" title="Edit" class="btn btn-secondary open-modal-btn" data-modal="editVehicle">
  <i class="fas fa-edit"></i>
</a>
            <a href="javascript:void(0);" title="Delete" class="btn btn-danger" onclick="deleteVehicle('{{ vehicle.id }}')"><i class="fas fa-trash-alt"></i></a>

            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Cities Table -->
    <!-- Cities Display -->
<div class="table-container">
  <h5 style="font-size: 17px;">Cities</h5>
  <div class="city-tags">
    {% for city in cities %}
      <div class="city-tag">
        {{ city.name }}
        <span class="remove-city" onclick="deleteCity('{{ city.id }}')">&times;</span>
      </div>
    {% endfor %}
  </div>
</div>

  </div>
</div>

<!-- add city modal -->
<div class="modal-overlay" id="addCityModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add City</h2>
      <button class="close-btn" onclick="closeModal(document.getElementById('addCityModal'))">&times;</button>
    </div>
    <div class="modal-content">
      <form id="addCityForm">
        <div class="form-group">
          <label class="form-group label">Search City</label>
          <div class="city-search-container">
            <input type="text" class="form-control" id="citySearch" placeholder="Start typing city name..." autocomplete="off">
            <div class="city-suggestions" id="citySuggestions"></div>
            <input type="hidden" id="selectedCity" name="name">
            <input type="hidden" id="selectedPlaceId" name="place_id">
          </div>
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-2" id="submitCityBtn">
          <span id="submitText">Add City</span>
          <span id="submitLoading" style="display: none;">
            <div class="loading-spinner"></div> Processing...
          </span>
        </button>
      </form>
    </div>
  </div>
</div>


<!-- vehicle type modal -->
<div class="modal-overlay" id="addVehicleModal">
  <div class="modal">
    <div class="modal-header">
      <h2>Add Vehicle Type</h2>
      <button class="close-btn">&times;</button>
    </div>
    <div class="modal-content">
      <form id="addVehicleType" enctype="multipart/form-data">
  <div class="form-group">
    <label for="VehicleName">Vehicle Type</label>
    <input type="text" class="form-control" id="VehicleName" name="name" required>
  </div>

  <div class="form-group">
    <label for="PassengerCount">Number of Passengers</label>
    <input type="number" class="form-control" id="PassengerCount" name="number_of_passengers" min="1" required>
  </div>
  <div class="form-group">
    <label for="VehicleImage">Vehicle Image</label>
    <input type="file" class="form-control" id="VehicleImage" name="image" accept="image/*" required>
  </div>
  <button type="submit" class="btn btn-primary w-100 mt-2">Add Vehicle Type</button>
</form>
    </div>
  </div>
</div>

<!-- edit vehicle modal -->
 <div class="modal-overlay" id="editVehicle">
  <div class="modal">
    <div class="modal-header">
      <h2>Edit Vehicle Type</h2>
      <button class="close-btn" onclick="closeModal(document.getElementById('editVehicleModal'))">&times;</button>
    </div>
    <div class="modal-content">
      <form id="editVehicleForm" enctype="multipart/form-data">
        <input type="hidden" id="editVehicleId">
        <div class="form-group">
          <label for="editVehicleName">Vehicle Type</label>
          <input type="text" class="form-control" id="editVehicleName" name="name" required>
        </div>
        <div class="form-group">
          <label for="editPassengerCount">Number of Passengers</label>
          <input type="number" class="form-control" id="editPassengerCount" name="number_of_passengers" min="1" required>
        </div>
        <div class="form-group">
          <label for="editVehicleImage">Vehicle Image</label>
          <input type="file" class="form-control" id="editVehicleImage" name="image" accept="image/*">
          <img id="editVehiclePreview" src="" width="80" style="margin-top: 10px; display: none;" />
        </div>
        <button type="submit" class="btn btn-primary w-100 mt-2">Update Vehicle Type</button>
      </form>
    </div>
  </div>
</div>

<!-- add city script -->
<!-- add city script -->
<script>
// Google Places API Autocomplete implementation
document.addEventListener('DOMContentLoaded', function() {
  const citySearch = document.getElementById('citySearch');
  const citySuggestions = document.getElementById('citySuggestions');
  const selectedCity = document.getElementById('selectedCity');
  const selectedPlaceId = document.getElementById('selectedPlaceId');
  const submitCityBtn = document.getElementById('submitCityBtn');
  const submitText = document.getElementById('submitText');
  const submitLoading = document.getElementById('submitLoading');
  
  let autocompleteService;
  let geocoderService;
  let sessionToken;
  
  // Initialize Google Places Autocomplete service
  function initAutocompleteService() {
    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
      // Use the new AutocompleteService (not the deprecated one)
      autocompleteService = new google.maps.places.AutocompleteService();
      geocoderService = new google.maps.Geocoder();
      sessionToken = new google.maps.places.AutocompleteSessionToken();
    } else {
      console.error('Google Maps JavaScript API not loaded');
      showToast("City search functionality not available", "error");
    }
  }
  
  // Load Google Maps API with proper async loading
  function loadGoogleMapsAPI() {
    // Use the API key from Django template variable
    const apiKey = '{{ google_maps_api_key }}';
    
    if (!apiKey) {
      console.error('Google Maps API key not found');
      showToast("City search functionality not available", "error");
      return;
    }
    
    // Create the script element with proper async loading
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&loading=async&callback=initAutocompleteService&region=IN`;
    script.async = true;
    script.defer = true;
    
    // Add the script to the document head
    document.head.appendChild(script);
  }
  
  // Global callback function for Google Maps API
  window.initAutocompleteService = initAutocompleteService;
  
  // Start loading the Google Maps API
  loadGoogleMapsAPI();
  
  // Debounce function to limit API requests
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
  
  // Handle input events for city search with debouncing
  const handleCitySearch = debounce(function(searchTerm) {
    citySuggestions.innerHTML = '';
    citySuggestions.style.display = 'none';
    
    if (searchTerm.length < 2) return;
    
    if (!autocompleteService) {
      showToast("Search service not ready yet", "error");
      return;
    }
    
    // Request predictions from Google Places API
    autocompleteService.getPlacePredictions({
      input: searchTerm,
      types: ['(cities)'],
      sessionToken: sessionToken
    }, (predictions, status) => {
      if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
        if (status !== 'ZERO_RESULTS') {
          console.error('Autocomplete error:', status);
        }
        return;
      }
      
      if (predictions.length > 0) {
        citySuggestions.innerHTML = predictions.map(prediction => {
          const mainText = prediction.structured_formatting.main_text;
          const secondaryText = prediction.structured_formatting.secondary_text;
          const matchedSubstrings = prediction.structured_formatting.main_text_matched_substrings;
          
          // Highlight matched portions
          let highlightedText = mainText;
          if (matchedSubstrings && matchedSubstrings.length > 0) {
            const match = matchedSubstrings[0];
            const before = mainText.substring(0, match.offset);
            const matchText = mainText.substring(match.offset, match.offset + match.length);
            const after = mainText.substring(match.offset + match.length);
            highlightedText = `${before}<span class="highlight">${matchText}</span>${after}`;
          }
          
          return `<div class="city-suggestion" data-city="${mainText}" data-place-id="${prediction.place_id}">
                    ${highlightedText}
                    <small>${secondaryText || ''}</small>
                  </div>`;
        }).join('');
        
        citySuggestions.style.display = 'block';
      }
    });
  }, 300); // 300ms debounce time
  
  // Event listener for city search input
  citySearch.addEventListener('input', function() {
    const searchTerm = this.value.trim();
    handleCitySearch(searchTerm);
  });
  
  // Handle city selection
  citySuggestions.addEventListener('click', function(e) {
    const suggestion = e.target.closest('.city-suggestion');
    if (suggestion) {
      const cityName = suggestion.getAttribute('data-city');
      const placeId = suggestion.getAttribute('data-place-id');
      
      citySearch.value = cityName;
      selectedCity.value = cityName;
      selectedPlaceId.value = placeId;
      citySuggestions.style.display = 'none';
    }
  });
  
  // Close suggestions when clicking outside
  document.addEventListener('click', function(e) {
    if (!citySearch.contains(e.target) && !citySuggestions.contains(e.target)) {
      citySuggestions.style.display = 'none';
    }
  });
  
  // Function to get the official city name using Geocoding API
  function getOfficialCityName(placeId, callback) {
    if (!geocoderService) {
      console.error('Geocoder service not available');
      callback(null);
      return;
    }
    
    geocoderService.geocode({ placeId: placeId }, (results, status) => {
      if (status === 'OK' && results && results.length > 0) {
        const addressComponents = results[0].address_components;
        
        // Find the component with types ['locality', 'political']
        for (const component of addressComponents) {
          if (component.types.includes('locality') && component.types.includes('political')) {
            callback(component.long_name);
            return;
          }
        }
        
        // If locality not found, try administrative_area_level_2 or level_3
        for (const component of addressComponents) {
          if (component.types.includes('administrative_area_level_2') || 
              component.types.includes('administrative_area_level_3')) {
            callback(component.long_name);
            return;
          }
        }
        
        // Fallback to the first result's formatted address
        callback(results[0].formatted_address.split(',')[0]);
      } else {
        console.error('Geocoder failed due to: ' + status);
        callback(null);
      }
    });
  }
  
  // Form submission
  document.getElementById('addCityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const cityName = selectedCity.value.trim();
    const placeId = selectedPlaceId.value;
    
    if (!cityName || !placeId) {
      showToast("Please select a city from the list", "error");
      return;
    }
    
    // Show loading state
    submitText.style.display = 'none';
    submitLoading.style.display = 'inline';
    submitCityBtn.disabled = true;
    
    // Get the official city name using Geocoding API
    getOfficialCityName(placeId, function(officialCityName) {
      const finalCityName = officialCityName || cityName;
      
      // Send the city name to the server
      fetch("{% url 'add_city' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: JSON.stringify({ name: finalCityName })
      })
      .then(res => res.json())
      .then(data => {
        // Reset loading state
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
        submitCityBtn.disabled = false;
        
        if (data.success) {
          showToast("City added successfully");
          document.getElementById("addCityForm").reset();
          closeModal(document.getElementById("addCityModal"));
          setTimeout(() => {
            location.reload();
          }, 3000);
        } else {
          showToast(data.error || "Something went wrong", "error");
        }
      })
      .catch(err => {
        // Reset loading state
        submitText.style.display = 'inline';
        submitLoading.style.display = 'none';
        submitCityBtn.disabled = false;
        
        console.error(err);
        showToast("Network error", "error");
      });
    });
  });
});
</script>

<!-- vehicle type -->
<script>
  document.getElementById("addVehicleType").addEventListener("submit", function (e) {
    e.preventDefault();

    const form = document.getElementById("addVehicleType");
    const formData = new FormData(form);

    fetch("{% url 'add_vehicle_type' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("Vehicle type added successfully");
        form.reset();
        closeModal(document.getElementById("addVehicleModal"));

        // Reload the page after a short delay (e.g., 1.5 seconds)
        setTimeout(() => {
          location.reload();
        }, 1500);
      } else {
        showToast(data.error || "Something went wrong", "error");
      }
    })
    .catch(err => {
      console.error(err);
      showToast("Network error", "error");
    });
  });
</script>

<!-- script for editing vehicle details -->
 <script>
  function openEditModal(vehicleId) {
    vehicleId = parseInt(vehicleId)
    fetch(`/get-vehicle-type/${vehicleId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById("editVehicleId").value = data.id;
        document.getElementById("editVehicleName").value = data.name;
        document.getElementById("editPassengerCount").value = data.number_of_passengers;

        if (data.image_url) {
          document.getElementById("editVehiclePreview").src = data.image_url;
          document.getElementById("editVehiclePreview").style.display = "block";
        } else {
          document.getElementById("editVehiclePreview").style.display = "none";
        }

        openModal(document.getElementById("editVehicleModal"));
      });
  }

  document.getElementById("editVehicleForm").addEventListener("submit", function (e) {
    e.preventDefault();

    const id = document.getElementById("editVehicleId").value;
    const form = document.getElementById("editVehicleForm");
    const formData = new FormData(form);

    fetch(`/update-vehicle-type/${id}/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        showToast("Vehicle updated successfully");
        closeModal(document.getElementById("editVehicle"));
        setTimeout(() => location.reload(), 1000);
      } else {
        showToast(data.error || "Update failed", "error");
      }
    });
  });
</script>

<!-- city delete script -->
 <script>
  function deleteCity(cityId) {
    cityId = parseInt(cityId)
    if (confirm("Are you sure you want to delete this city?")) {
      fetch(`/delete-city/${cityId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast("City deleted successfully");
          setTimeout(() => location.reload(), 800);
        } else {
          showToast(data.error || "Delete failed", "error");
        }
      });
    }
  }
</script>

<!-- delete vehicle script -->
<script>
  function deleteVehicle(vehicleId) {
    vehicleId = parseInt(vehicleId)
    if (confirm("Are you sure you want to delete?")) {
      fetch(`/delete-vehicle/${vehicleId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast("Deleted successfully");
          setTimeout(() => {
            location.reload();
          }, 3000); // 3-second delay to show toast
        } else {
          showToast(data.error || "Delete failed", "error");
        }
      })
      .catch(err => {
        console.error(err);
        showToast("Network error", "error");
      });
    }
  }
</script>

<!-- delete vehicle price -->
 <script>
  function deleteVehiclePrice(itemId) {
    itemId = parseInt(itemId)
    if (confirm("Are you sure you want to delete this?")) {
      fetch(`/delete-vehicle-price/${itemId}/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          showToast("Price deleted successfully");
          setTimeout(() => location.reload(), 800);
        } else {
          showToast(data.error || "Delete failed", "error");
        }
      });
    }
  }
</script>

{% endblock %}
