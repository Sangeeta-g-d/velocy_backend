<!DOCTYPE html>
<html>
  <head>
    <title>Live Ride Location</title>
    <style>
      body, html {
        margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: #f4f6f8;
      }
      #map { height: 100vh; width: 100%; }

      /* Ride info card */
      #ride-info {
        position: absolute;
        top: 15px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        width: 90%;
        max-width: 400px;
        z-index: 1000;
      }
      #ride-info h3 {
        margin: 0 0 10px;
        font-size: 18px;
        font-weight: 600;
        color: #333;
      }
      .ride-location {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }
      .ride-location:last-child {
        margin-bottom: 0;
      }
      .ride-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 10px;
      }
      .from-dot { background: #2ecc71; }
      .to-dot { background: #e74c3c; }
      .ride-text {
        flex: 1;
        font-size: 14px;
        color: #444;
      }
    </style>
  </head>
  <body>
    <!-- Ride Info Card -->
    <div id="ride-info">
      <h3>ðŸš– Ride Info</h3>
      <div class="ride-location">
        <div class="ride-dot from-dot"></div>
        <div class="ride-text"><strong>From:</strong> {{ from_location }}</div>
      </div>
      <div class="ride-location">
        <div class="ride-dot to-dot"></div>
        <div class="ride-text"><strong>To:</strong> {{ to_location }}</div>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>
    
    <script>
      let map, liveMarker, fromMarker, toMarker;
      const sessionId = "{{ session_id }}";  
      const socket = new WebSocket("wss://{{ request.get_host }}/ws/share-ride/" + sessionId + "/");

      async function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: { lat: {{ from_lat }}, lng: {{ from_lng }} },
          disableDefaultUI: true,
          styles: [
            { featureType: "poi", stylers: [{ visibility: "off" }] },
            { featureType: "transit", stylers: [{ visibility: "off" }] }
          ]
        });

        fromMarker = new google.maps.Marker({
          position: { lat: {{ from_lat }}, lng: {{ from_lng }} },
          map: map,
          label: "A",
          title: "Pickup: {{ from_location }}"
        });

        toMarker = new google.maps.Marker({
          position: { lat: {{ to_lat }}, lng: {{ to_lng }} },
          map: map,
          label: "B",
          title: "Drop: {{ to_location }}"
        });

        liveMarker = new google.maps.Marker({ 
          map: map,
          icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          title: "Live Location"
        });

        try {
          const res = await fetch("https://{{ request.get_host }}/emergency-share/" + sessionId + "/");
          if (res.ok) {
            const data = await res.json();
            if (data.latitude && data.longitude) {
              const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
              liveMarker.setPosition(pos);
              map.setCenter(pos);
            }
          }
        } catch (err) {
          console.error("Error fetching initial location", err);
        }
      }

      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
        if (liveMarker) {
          liveMarker.setPosition(pos);
          map.setCenter(pos);
        }
      };
    </script>

    <!-- Load Google Maps API with callback -->
    <script async defer 
      src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&callback=initMap">
    </script>
  </body>
</html>
