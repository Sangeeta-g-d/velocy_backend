<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Ride Location</title>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&loading=async"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      
      body, html {
        height: 100%;
        background: #f5f7fa;
      }
      
      .container {
        display: flex;
        flex-direction: column;
        height: 100%;
      }
      
      .header {
        background: linear-gradient(135deg, #4a6bdf 0%, #322fd6 100%);
        color: white;
        padding: 16px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      
      .header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .header h1 i {
        font-size: 1.8rem;
      }
      
      .ride-info-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-top: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      }
      
      .location-row {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding: 10px;
        border-radius: 8px;
        transition: background-color 0.2s;
      }
      
      .location-row:hover {
        background-color: #f9fafc;
      }
      
      .location-icon {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
      }
      
      .from-icon {
        background-color: #e3f2fd;
        color: #1565c0;
      }
      
      .to-icon {
        background-color: #e8f5e9;
        color: #2e7d32;
      }
      
      .location-text {
        flex: 1;
      }
      
      .location-label {
        font-size: 0.8rem;
        color: #78909c;
        margin-bottom: 4px;
      }
      
      .location-value {
        font-weight: 500;
        color: #37474f;
      }
      
      .divider {
        height: 20px;
        width: 2px;
        background: #e0e0e0;
        margin-left: 17px;
        margin-bottom: 5px;
      }
      
      #map {
        flex: 1;
        width: 100%;
      }
      
      .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background: white;
        border-top: 1px solid #e0e0e0;
        font-size: 0.9rem;
        color: #546e7a;
      }
      
      .driver-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .driver-avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        background: #bbdefb;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #0d47a1;
        font-weight: bold;
      }
      
      .eta {
        font-weight: 600;
        color: #4a6bdf;
      }
      
      @media (max-width: 600px) {
        .header h1 {
          font-size: 1.3rem;
        }
        
        .location-value {
          font-size: 0.9rem;
        }
        
        .status-bar {
          flex-direction: column;
          gap: 8px;
          align-items: flex-start;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1><i class="fas fa-taxi"></i> Live Ride Tracking</h1>
        <div class="ride-info-card">
          <div class="location-row">
            <div class="location-icon from-icon">
              <i class="fas fa-location-arrow"></i>
            </div>
            <div class="location-text">
              <div class="location-label">FROM</div>
              <div class="location-value">{{ from_location }}</div>
            </div>
          </div>
          
          <div class="divider"></div>
          
          <div class="location-row">
            <div class="location-icon to-icon">
              <i class="fas fa-flag-checkered"></i>
            </div>
            <div class="location-text">
              <div class="location-label">TO</div>
              <div class="location-value">{{ to_location }}</div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="map"></div>
      
      <div class="status-bar">
        <div class="driver-info">
          {% if ride.driver %}
          <div class="driver-avatar">
            {{ ride.driver.username|make_list|first|upper }}{{ ride.driver.username|make_list|last|upper }}
          </div>
          <div>{{ ride.driver.username }} â€¢ 
            {% if ride.vehicle_type %}
              {{ ride.vehicle_type.name }}
            {% else %}
              Vehicle info not available
            {% endif %}
          </div>
          {% else %}
          <div class="driver-avatar">
            <i class="fas fa-user-clock"></i>
          </div>
          <div>Waiting for driver assignment</div>
          {% endif %}
        </div>
        <div class="eta">
          {% if ride.driver %}
            ETA: <span id="eta-time">Calculating...</span>
          {% else %}
            ETA: Not available
          {% endif %}
        </div>
      </div>
    </div>
    
    <script>
      let map, liveMarker, fromMarker, toMarker;
      const sessionId = "{{ session_id }}";  // dynamic from Django
      const socket = new WebSocket("wss://{{ request.get_host }}/ws/share-ride/" + sessionId + "/");

      // Function to calculate ETA based on distance and average speed
      function calculateETA(distanceKm) {
        // Assuming average speed of 30 km/h in urban areas
        const averageSpeed = 30; // km/h
        const etaMinutes = Math.round((distanceKm / averageSpeed) * 60);
        return etaMinutes > 0 ? etaMinutes + " min" : "Arrived";
      }

      async function initMap() {
        // Initialize map
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: { lat: {{ from_lat }}, lng: {{ from_lng }} }, // start from pickup
          styles: [
            {
              "elementType": "geometry",
              "stylers": [{ "color": "#f5f5f5" }]
            },
            {
              "elementType": "labels.icon",
              "stylers": [{ "visibility": "off" }]
            },
            {
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#616161" }]
            },
            {
              "elementType": "labels.text.stroke",
              "stylers": [{ "color": "#f5f5f5" }]
            },
            {
              "featureType": "administrative.land_parcel",
              "stylers": [{ "visibility": "off" }]
            },
            {
              "featureType": "administrative.land_parcel",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#bdbdbd" }]
            },
            {
              "featureType": "administrative.neighborhood",
              "stylers": [{ "visibility": "off" }]
            },
            {
              "featureType": "poi",
              "elementType": "geometry",
              "stylers": [{ "color": "#eeeeee" }]
            },
            {
              "featureType": "poi",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#757575" }]
            },
            {
              "featureType": "poi.park",
              "elementType": "geometry",
              "stylers": [{ "color": "#e5e5e5" }]
            },
            {
              "featureType": "poi.park",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#9e9e9e" }]
            },
            {
              "featureType": "road",
              "elementType": "geometry",
              "stylers": [{ "color": "#ffffff" }]
            },
            {
              "featureType": "road",
              "elementType": "labels.icon",
              "stylers": [{ "visibility": "off" }]
            },
            {
              "featureType": "road.arterial",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#757575" }]
            },
            {
              "featureType": "road.highway",
              "elementType": "geometry",
              "stylers": [{ "color": "#dadada" }]
            },
            {
              "featureType": "road.highway",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#616161" }]
            },
            {
              "featureType": "road.local",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#9e9e9e" }]
            },
            {
              "featureType": "transit.line",
              "elementType": "geometry",
              "stylers": [{ "color": "#e5e5e5" }]
            },
            {
              "featureType": "transit.station",
              "elementType": "geometry",
              "stylers": [{ "color": "#eeeeee" }]
            },
            {
              "featureType": "water",
              "elementType": "geometry",
              "stylers": [{ "color": "#c9c9c9" }]
            },
            {
              "featureType": "water",
              "elementType": "labels.text.fill",
              "stylers": [{ "color": "#9e9e9e" }]
            }
          ]
        });

        // From marker
        fromMarker = new google.maps.Marker({
          position: { lat: {{ from_lat }}, lng: {{ from_lng }} },
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#1565C0",
            fillOpacity: 1,
            strokeColor: "#FFFFFF",
            strokeWeight: 2
          },
          title: "Pickup: {{ from_location }}"
        });

        // To marker
        toMarker = new google.maps.Marker({
          position: { lat: {{ to_lat }}, lng: {{ to_lng }} },
          map: map,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: "#2E7D32",
            fillOpacity: 1,
            strokeColor: "#FFFFFF",
            strokeWeight: 2
          },
          title: "Drop: {{ to_location }}"
        });

        // Live marker for user
        liveMarker = new google.maps.Marker({ 
          map: map,
          icon: {
            url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            scaledSize: new google.maps.Size(40, 40)
          },
          title: "Live Location"
        });

        // Calculate and display ETA if driver is assigned
        {% if ride.driver %}
        document.getElementById('eta-time').textContent = calculateETA({{ ride.distance_km }});
        {% endif %}

        // Fetch initial location
        try {
          const res = await fetch("https://{{ request.get_host }}/emergency-share/" + sessionId + "/");
          if (res.ok) {
            const data = await res.json();
            if (data.latitude && data.longitude) {
              const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
              liveMarker.setPosition(pos);
              map.setCenter(pos);
            }
          }
        } catch (err) {
          console.error("Error fetching initial location", err);
        }
      }

      socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
        liveMarker.setPosition(pos);
        map.setCenter(pos);
        
        // Update ETA based on current position (simplified)
        {% if ride.driver %}
        const distanceToDestination = google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(pos.lat, pos.lng),
          new google.maps.LatLng({{ to_lat }}, {{ to_lng }})
        ) / 1000; // Convert to kilometers
        
        document.getElementById('eta-time').textContent = calculateETA(distanceToDestination);
        {% endif %}
      };

      window.onload = initMap;
    </script>
    
    {% if ride.driver %}
    <script src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=geometry&loading=async"></script>
    {% endif %}
  </body>
</html>